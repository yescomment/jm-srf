---

---
<section id="window">
  <div id="sigma-container"></div>
</section>

<style lang:scss>
  #window {
    height: 100vh;
    background: transparent;
  }

  #sigma-container {
    position: fixed;
    top: 0;
    left: 0;
    height: 100vh;
    width: 100vw;
  }
</style>

<script>
  import { createNodeImageProgram } from "@sigma/node-image";
  import EdgeCurveProgram from "@sigma/edge-curve"
  import Graph from "graphology";
  import ForceSupervisor from "graphology-layout-force/worker";
  import Sigma from "sigma";

  import iconHouse from '@material-symbols/svg-400/rounded/house.svg'
  import iconHouses from '@material-symbols/svg-400/rounded/other_houses.svg'
  import iconEducation from '@material-symbols/svg-400/rounded/school.svg'
  import iconFactory from '@material-symbols/svg-400/rounded/factory.svg'
  import iconLaw from '@material-symbols/svg-400/rounded/gavel.svg'
  import iconHealth from '@material-symbols/svg-400/rounded/healing.svg'
  import iconGovernment from '@material-symbols/svg-400/rounded/account_balance.svg'
  import iconIdentity from '@material-symbols/svg-400/rounded/fingerprint.svg'
  import iconWages from '@material-symbols/svg-400/rounded/payments.svg'
  import iconPolice from '@material-symbols/svg-400/rounded/local_police.svg'

  const container = document.getElementById("sigma-container");
  const graph = new Graph();

  const dN = {
    size: 20,
    color: 'white',
    type: "image",
    forceLabel: true,
  }

  const dE = {
    type: "arrow",
    color: '#323835',
    size: 5,
    forceLabel: true,
  }

  graph.addNode("neighborhoods", {...dN, label: "Neighborhoods", image: iconHouses.src});
  graph.addNode("housing", {...dN, label: "Housing", image: iconHouse.src});
  graph.addNode("education", {...dN, label: "Education", image: iconEducation.src});
  graph.addNode("manufacturing", {...dN, label: "Manufacturing", image: iconFactory.src});
  graph.addNode("law", {...dN, label: "Law", image: iconLaw.src});
  graph.addNode("healthcare", {...dN, label: "Healthcare", image: iconHealth.src});
  graph.addNode("legislators", {...dN, label: "Legislators", image: iconGovernment.src});
  graph.addNode("police", {...dN, label: "Police", image: iconPolice.src});
  graph.addNode("identity", {...dN, label: "Identity", image: iconIdentity.src});
  graph.addNode("wages", {...dN, label: "Wages", image: iconWages.src});

  graph.addEdge("neighborhoods", "housing", {...dE, label: "contain"});
  graph.addEdge("housing", "identity", {...dE, label: "builds belonging"});
  graph.addEdge("law", "manufacturing", {...dE, label: "protects"});
  graph.addEdge("education", "law", {...dE, label: "ensures quality"});
  graph.addEdge("identity", "neighborhoods", {...dE, label: "defines uniqueness"});
  graph.addEdge("healthcare", "manufacturing", {...dE, label: "is an opportunity for"});
  graph.addEdge("police", "law", {...dE, label: "enforces"});
  graph.addEdge("law", "police", {...dE, label: "limits"});
  graph.addEdge("law", "housing", {...dE, label: "protects"});

  graph.nodes().forEach((node, i) => {
    const angle = (i * 2 * Math.PI) / graph.order;
    graph.setNodeAttribute(node, "x", 100 * Math.cos(angle));
    graph.setNodeAttribute(node, "y", 100 * Math.sin(angle));
  });


  // RENDERING

  const renderer = new Sigma(graph, container, {
    nodeProgramClasses: {
      image: createNodeImageProgram(),
    },
    edgeProgramClasses: {
      curved: EdgeCurveProgram,
    },
    renderEdgeLabels: true,
  });

  let draggedNode: string | null = null;
  let isDragging = false;

  renderer.on("downNode", (e) => {
    isDragging = true;
    draggedNode = e.node;
    graph.setNodeAttribute(draggedNode, "highlighted", true);
  });

  // On mouse move, if the drag mode is enabled, we change the position of the draggedNode
  renderer.getMouseCaptor().on("mousemovebody", (e) => {
    if (!isDragging || !draggedNode) return;

    // Get new position of node
    const pos = renderer.viewportToGraph(e);

    graph.setNodeAttribute(draggedNode, "x", pos.x);
    graph.setNodeAttribute(draggedNode, "y", pos.y);

    // Prevent sigma to move camera:
    e.preventSigmaDefault();
    e.original.preventDefault();
    e.original.stopPropagation();
  });

  // On mouse up, we reset the autoscale and the dragging mode
  renderer.getMouseCaptor().on("mouseup", () => {
    if (draggedNode) {
      graph.removeNodeAttribute(draggedNode, "highlighted");
    }
    isDragging = false;
    draggedNode = null;
  });

  // Disable the autoscale at the first down interaction
  renderer.getMouseCaptor().on("mousedown", () => {
    if (!renderer.getCustomBBox()) renderer.setCustomBBox(renderer.getBBox());
  });

  // Create the spring layout and start it
  const layout = new ForceSupervisor(graph, {
    settings: {
      attraction: .000008,
      repulsion: 0.9,
    }
  });

  layout.start();
</script>